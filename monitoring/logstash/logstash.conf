input {
  # Backend application logs
  tcp {
    port => 5000
    codec => json_lines
  }

  # Nginx access logs
  file {
    path => "/var/log/nginx/access.log"
    type => "nginx-access"
    start_position => "beginning"
  }

  # Nginx error logs
  file {
    path => "/var/log/nginx/error.log"
    type => "nginx-error"
    start_position => "beginning"
  }
}

filter {
  # Parse Spring Boot JSON logs
  if [type] == "spring-boot" {
    json {
      source => "message"
    }
    
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
    
    mutate {
      remove_field => ["message"]
    }
  }

  # Parse Nginx access logs
  if [type] == "nginx-access" {
    grok {
      match => {
        "message" => '%{IPORHOST:remote_addr} - %{DATA:remote_user} \[%{HTTPDATE:timestamp}\] "%{WORD:method} %{DATA:request} HTTP/%{NUMBER:http_version}" %{NUMBER:status} %{NUMBER:body_bytes_sent} "%{DATA:http_referer}" "%{DATA:http_user_agent}" "%{DATA:http_x_forwarded_for}" rt=%{NUMBER:request_time} uct="%{DATA:upstream_connect_time}" uht="%{DATA:upstream_header_time}" urt="%{DATA:upstream_response_time}"'
      }
    }
    
    date {
      match => ["timestamp", "dd/MMM/yyyy:HH:mm:ss Z"]
      target => "@timestamp"
    }
    
    mutate {
      convert => {
        "status" => "integer"
        "body_bytes_sent" => "integer"
        "request_time" => "float"
      }
    }
  }

  # Parse Nginx error logs
  if [type] == "nginx-error" {
    grok {
      match => {
        "message" => '%{TIMESTAMP_ISO8601:timestamp} \[%{LOGLEVEL:log_level}\] %{GREEDYDATA:error_message}'
      }
    }
    
    date {
      match => ["timestamp", "yyyy/MM/dd HH:mm:ss"]
      target => "@timestamp"
    }
  }

  # Add geo location for remote IPs (optional)
  if [remote_addr] {
    geoip {
      source => "remote_addr"
      target => "geoip"
    }
  }

  # Add tags for critical errors
  if [log_level] == "ERROR" or [status] >= 500 {
    mutate {
      add_tag => ["error"]
    }
  }
  
  if [status] == 401 or [status] == 403 {
    mutate {
      add_tag => ["security"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "exam-portal-%{+YYYY.MM.dd}"
    
    # Separate indexes for different log types
    if [type] == "spring-boot" {
      index => "app-logs-%{+YYYY.MM.dd}"
    } else if [type] == "nginx-access" {
      index => "nginx-access-%{+YYYY.MM.dd}"
    } else if [type] == "nginx-error" {
      index => "nginx-error-%{+YYYY.MM.dd}"
    }
  }

  # Output to stdout for debugging (disable in production)
  stdout {
    codec => rubydebug
  }
}
